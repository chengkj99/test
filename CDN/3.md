
> 缓存（Cache）是CDN的基础技术和组成单元，从外部看，整个CDN像一个大的Cache向外部提供服务。

## 1 内容缓存技术的发展背景

 随着网络内容和用户数量的增长，网站服务面临瓶颈。 为此，提高服务器硬件配置、后来出现多台服务器组成服务器集群负载分担，但这些都没有解决网络延迟、“最后一公里”等问题，所以，内容缓存技术出现了。

#### 网站的问题和需求：

- 网站无法及时满足用户增长的需要；
- 不容易满足远处客户的需要；
- 设置镜像后，中心服务器和镜像之间同步不及时；
- 一个镜像失败，无法及时高效的切换调度最近的镜像服务；
- 通过部署更多镜像解决问题增加成本；
- 中心服务器IP暴露易遭受DDos攻击；

这些问题也是CDN致力于解决的问题；

#### CDN出现前的网站服务技术：

 ##### 扩展技术 Scale up／out
  - 提高服务器硬件配置
  - 采用服务器集群技术
 ##### 镜像技术 Mirroring
  - 镜像：数字媒体的服务能力和完整内容备份到网络上不同地址的另一个地方。
  - 实现：对整个网站进行镜像复制，多点部署（不同地区不同运营商）。
 ##### 缓存技术
  - 缓存：访问过的内容储存起来，为后续重复访问使用。
  - 缓存代理服务一定范围的访问域（分层缓存）。
  - CDN将内容缓存到离用户最近的地方实现就近服务；可以说，CDN就是在缓存技术的基础上发展起来的，

也可以说，CDN是缓存的分布式集群实现。（负载均衡系统、运营管理系统是为了各个缓存节点更好的协同工作）
  CDN也可以理解为是（智能调度）+（分层缓存技术）的组合。


## 2 Cache设备工作方式和设计要求

#### Cache设备：
<!-- 我们是怎么进行区分开发的：我们目前没有区分进行开发 -->
  - 根据内容不同，将Cache设备分为 Web Cache（只要用于网页内容和对象） 和 流媒体 Cache（主要用于视频流媒体加速服务）。   大多数设备厂商不会对两者进行区分。但是，CDN服务提供商会对两类服务分别进行开发和优化（内容类型、用户行为、内容更新的差异）。
  - Web Cache：
    - WebCache作为一种网页缓存技术，可以在任何一个中间网元上实现。
    - 通常，一次网页访问，会涉及四个关键网元：用户、代理、网关、Web服务器。
    - WebCache通常作为代理或网关部署在用户访问路径上。
    - 部署位置不同，工作模式不同，对WebCache有不同的要求。
  - 部署在代理位置时：透明代理、正向代理模式进行服务。
  - 部署在网关位置时：反向代理。（多数部署在网关）

#### 代理模式：
  <!-- 我们主要使用的是反向代理 -->
  1. 正向代理
    配置正向代理的服务器地址和端口号即可。也常用于中小企业网络环境的搭建。
  2. 反向代理
  <!--  反向代理服务器怎么接收客户端的请求的-->
    反向代理服务器会接收用户的请求向原始服务器进行请求并响应。
  3. 透明代理
  <!-- 截获请求，怎么截获的？ 网关默认截获 -->
    可以看作是通过网络设备和协议实现的正向代理工作模式。


#### WebCache 产品实现关键要素分析

- WebCache应具备HTTP协议所描述的基本功能(转发访问请求)。
- 要根据应用场景和工作模式来确定WebCache具备的功能：
- 面向企业时：主要考虑正向代理、透明代理、用户数量、并发链接数、流量大小、存储空间、缓存大小，以及数据分析、过滤和安全保障能力等情况
- 面向Web站点时：主要考虑新增链接的处理能力、并发链接处理能力、存储空间和缓存大小等性能指标


## 3 Web Cache的实现基础 - 基于HTTP协议的Web缓存技术

##### Web与HTTP
WEB：
- 互联网被大众接受，是万维网（World Wide Web）的诞生开始的。
- Web特性： 跨平台性、交互性
- Web三个精华之处：
  - 用超文本技术 HTML 实现信息和信息的链接
  - 用统一资源定位符 URL 实现全球信息的精确定位
  - 用应用层协议 HTTP 实现分布式的信息共享

HTTP：
- HTTP请求前需建立好TCP链接；
- HTTP是无状态协议，每次请求和响应都是独立的。
- HTTP链接：
  1. 非持久链接
  2. 持续链接机制
    - 不带流水线的链接：只有在上一个请求响应后才能发出下一个请求；
    - 带流水线：发现引用就可发起链接；

在HTTP1.1中，默认的是持续的带流水线的HTTP链接。对应的是HTTP 头中的 Connection: Keep-Alive（持久链接） or false（非持久链接）



##### HTTP工作方式：请求 + 响应
<!-- 实体，隧道？ -->
关键概念：连接、消息、请求、响应、资源、实体、客户端、服务器、源服务器、代理、网关、隧道、缓存
HTTP请求格式：
```
请求方法 URL 版本号
通用头1： 通用头值1
...
通用头N： 通用头N
...
请求头1: 请求头N
...
请求头： 请求头N
实体头1: 实体头N
...
实体头： 实体头N

实体内容

```

请求方式：GET、HEAD、POST、PUT、DELETE、TRACE、CONNECT
通用请求头：Connection、Date、Pragma、Transfer-Encoding、Upgrade、Via、Warning

常用请求头：Accept Accept-Charset ...

此外还有响应格式、响应方式、响应头。

除了以上基本原理之外，还有Cookie、Session、安全协议、缓存机制关键应用。


##### HTTP中的Cookie和Session

在请求发出去前，浏览器会先查看本地是否保存此网站的cookie文件，如果有会将cookie信息放在cookie头中一并发出去，如果没有，则不会发送。

Cookie信息的Exporation有效期设置，如果没有设置，浏览器认为不保存Cookie信息；
每个客户端最多保存300个Cookie；每个域下20个；
Cookie欺骗；

服务器将SessionID返回给浏览器两种方法：一种是cookie方法；URL重写；

两者在应用场景、安全性、性能、失效性、等其他方面存在区别；

##### HTTPS安全协议

HTTP + SSL 更能保证整个通信的保密性；

##### HTTP协议中的缓存技术
- 使用缓存三大好处：减少延迟；减少网络损耗；降低服务器负载；
- HTTP协议定义了各种各样的缓存控制方法，合理使用，帮助提高网站服务能力；
- 缓存工作的基本原则；
  - 头信息设置不缓存 、源服务器认证或涉及安全协议，使请求内容不被缓存；
  - 含有过期时间和寿命信息、且此内容没有过期、缓存内容近期提供过服务且最后更新时间相对于最近使用的时间较持久，使的不需要从源服务器重新获取内容；
  - 若缓存内容已过期，缓存内容服务器向源服务器发出认证是否可以继续使用当前内容；
  - 若网络中断，缓存内容在过期的情况下继续提供服务；
  - 如果响应消息中不存在用于判断内容是否变化的值（ETag、Last-Modified），且没有任何新鲜度的消息，内容不会被缓存。
- 控制缓存的方法：
  - HTML META标签和HTTP头信息
  - Expires（过期时间）头信息来控制保鲜期
  - 验证（验证缓存内容是否可用）
  - Cache-Control（缓存控制）HTTP 头信息
  - Pragma HTTP 头信息

## 4 Web Cache 技术实现关键点分析

WebCache多采用反向代理的工作方式，用于衡量设备的关键性能指标：

##### 关键性能指标
并发量、吞吐量、命中率、请求时间和丢包率

##### 内容存储机制
三种方案：共享存储、本地附加存储（DAS）、分布式存储
<!-- 现在不考虑存储机制的技术方案，硬件设备存储能力很强。 -->

##### 内容更新机制
涉及两方面的内容：哪些内容需要缓存？缓存内容如何更新？
缓存原则：
1. 头信息告诉Cache不用缓存
2. 内容的请求信息需要认证或安全加密的，不缓存
3. 在HTTP响应中没有Etag或Last-Modified头信息，Cache会认为缺少直接的更新度信息，默认不缓存；
4. Cache认为缓存内容是足够新的，不会去源站请求；（1.完整的过期时间和寿命控制头信息；2.缓存内容被使用过，并检查过新鲜度。）
5. 如果缓存内容很旧了，会向源站进行验证是否继续可用，如果可用将避免重新获取。
（根据经验，一般html文件、图片等静态资源会被缓存；而动态资源一般不会被缓存。）

##### Web Cache 协议优化
对Web Cache的性能优化除了可以从存储机制、内容更新机制入手，也可以从协议优化入手；

优化方法：
1. HTTP链接聚合(把多个短链接聚合成一个长链接，减少频繁开启关闭TCP链接带来的资源消耗)
2. HTTP gzip压缩（网页中音乐、视频等文件被压缩过，再压缩处理效果不大；对HTML、CSS、JS等文件进行压缩可以取得较好的效果）
<!-- 链接聚合：比如十个人同时请求一个链接，WebCache回源一次。 -->

##### Web Cache安全实现机制

1. 访问控制
1. 病毒防护
1. 网络安全防护
1. 内容加密

## 开源的Web缓存代理软件-squid
功能：
1. web代理
1. 内容缓存和加速
1. ACL访问控制
1. 用户认证
1. 日志
